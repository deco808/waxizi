<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZK6CD9HS88"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-ZK6CD9HS88');
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>鹫巢外传</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary-color: #4a6fa5;
      --secondary-color: #6b8cae;
      --accent-color: #ffcc00;
      --light-bg: #f5f7fa;
      --card-bg: #ffffff;
      --text-color: #333333;
      --border-color: #d1e3f6;
      --talk-bg: #eef7ff;
    }

    * { margin:0; padding:0; box-sizing:border-box; font-family:'Microsoft YaHei','Segoe UI',sans-serif; }

    body { background:var(--light-bg); color:var(--text-color); line-height:1.6; min-height:100vh; transition:padding 0.3s ease; padding-bottom:60px; }

    /* 顶部 */
    .header { padding:20px; text-align:center; background:var(--card-bg); border-bottom:2px solid var(--primary-color); position:sticky; top:0; z-index:100; box-shadow:0 2px 10px rgba(0,0,0,.1); transition:transform .3s ease; }
    .title { font-size:2.0rem; color:var(--primary-color); margin-bottom:4px; }
    .subtitle { font-size:1.0rem; color:var(--secondary-color); }

    /* 阅读模式工具条 */
    .viewer-toolbar { position:sticky; top:72px; z-index:95; background:rgba(255,255,255,.95); border-bottom:1px solid var(--border-color); box-shadow:0 1px 8px rgba(0,0,0,.06); transition:transform .3s ease; }
    .viewer-toolbar.hidden { transform: translateY(-100%); }
    .viewer-toolbar .inner { max-width:1000px; margin:0 auto; padding:8px 12px; display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap; }
    .viewer-toolbar label { display:flex; align-items:center; gap:6px; font-size:.95rem; color:#375985; }
    .viewer-toolbar select, .viewer-toolbar input[type="checkbox"], .viewer-toolbar button { padding:6px 10px; border:1px solid var(--border-color); border-radius:8px; background:#fff; cursor:pointer; }
    .viewer-toolbar button { display:flex; align-items:center; gap:6px; }

    /* 提示条 */
    .notice { background:linear-gradient(to right,#b30000,#cc0000); color:#fff; font-weight:bold; padding:14px; text-align:center; max-width:800px; margin:12px auto; border-radius:8px; border:2px solid #ff5252; box-shadow:0 0 15px rgba(255,82,82,.3); }

    /* 竖向滚动阅读容器 */
    .comic-container { max-width:800px; margin:0 auto; padding:15px; }
    .comic-image { display:block; width:100%; height:auto; margin-bottom:15px; border-radius:8px; background:#f8f9fa; box-shadow:0 3px 10px rgba(0,0,0,.1); border:1px solid var(--border-color); opacity:0; transform:translateY(20px); transition:all .5s ease; }
    .comic-image.loaded { opacity:1; transform:translateY(0); }

    .loading-container { text-align:center; padding:50px 20px; color:#6c757d; font-size:1.1rem; }
    .loading-spinner { width:50px; height:50px; border:5px solid rgba(74,111,165,.2); border-top:5px solid var(--primary-color); border-radius:50%; margin:0 auto 16px; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* 翻页阅读（单页/双页） */
    .flip-view { display:none; max-width:1400px; margin:0 auto; position:relative; }
    .flip-stage { height: calc(100vh - 170px); /* 头部+工具条高度预留 */
                  display:flex; align-items:center; justify-content:center; gap:12px; padding:10px; }
    .flip-stage img { max-height:100%; width:auto; border-radius:10px; background:#f8f9fa; border:1px solid var(--border-color); box-shadow:0 4px 16px rgba(0,0,0,.10); }
    .flip-hotspot { position:absolute; top:0; bottom:0; width:50%; cursor:pointer; }
    .flip-hotspot.left { left:0; }
    .flip-hotspot.right { right:0; }
    /* 不显示任何键盘提示 */

    /* 碎碎念 */
    .talk-section { background:var(--talk-bg); border-radius:10px; padding:22px; margin:26px auto; max-width:800px; border-left:4px solid var(--primary-color); box-shadow:0 3px 10px rgba(0,0,0,.05); }
    .talk-content { line-height:1.8; font-size:1.05rem; }
    .talk-content p { margin-bottom:14px; }

    /* 页脚 & 状态条 */
    .footer { background:var(--card-bg); padding:26px 20px; text-align:center; margin-top:26px; border-top:1px solid var(--border-color); box-shadow:0 -2px 10px rgba(0,0,0,.05); }
    .footer-title { color:var(--primary-color); font-size:1.2rem; margin-bottom:16px; font-weight:bold; }
    .staff-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:12px; max-width:800px; margin:0 auto; }
    .staff-item { background:#f8fbff; padding:10px; border-radius:8px; border:1px solid var(--border-color); box-shadow:0 2px 5px rgba(0,0,0,.05); }
    .staff-role { font-weight:bold; color:var(--primary-color); margin-bottom:4px; }

    .status-bar { position:fixed; bottom:0; left:0; width:100%; background:rgba(255,255,255,.95); padding:10px; font-size:1rem; text-align:center; color:var(--primary-color); display:flex; justify-content:center; align-items:center; gap:10px; z-index:100; transition:transform .3s ease; border-top:1px solid var(--border-color); box-shadow:0 -2px 10px rgba(0,0,0,.1); }
    .status-bar.hidden { transform: translateY(100%); }
    .progress-container { width:200px; height:8px; background:rgba(74,111,165,.12); border-radius:4px; overflow:hidden; }
    .progress-bar { height:100%; background:linear-gradient(to right,var(--primary-color),var(--secondary-color)); width:0%; transition:width .3s ease; }

    /* 导航浮层（章节跳转） */
    .nav-overlay { position:fixed; inset:0; background:rgba(255,255,255,.96); display:flex; justify-content:center; align-items:center; z-index:200; opacity:0; visibility:hidden; transition:all .25s ease; }
    .nav-overlay.active { opacity:1; visibility:visible; }
    .nav-buttons { display:flex; gap:28px; }
    .nav-btn { width:96px; height:96px; border-radius:50%; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#fff; border:2px solid var(--primary-color); color:var(--primary-color); font-size:1rem; cursor:pointer; transition:all .3s ease; box-shadow:0 5px 15px rgba(0,0,0,.1); }
    .nav-btn i { font-size:2.1rem; margin-bottom:6px; }
    .nav-btn:hover { background:var(--primary-color); color:#fff; transform:scale(1.06); }
    .nav-btn.center { background:var(--primary-color); color:#fff; border-color:var(--primary-color); }

    /* 隐藏页眉页脚时 */
    .header.hidden { transform:translateY(-100%); }
    .footer.hidden { transform:translateY(100%); }

    .end-indicator { height:1px; position:absolute; bottom:300px; width:100%; }

    /* 小屏优化 */
    @media (max-width:600px){
      .title{ font-size:1.6rem; }
      .subtitle{ font-size:.95rem; }
      .viewer-toolbar .inner{ padding:8px 10px; gap:8px; }
      .nav-buttons{ flex-direction:column; gap:18px; }
      .nav-btn{ width:84px; height:84px; }
      .nav-btn i{ font-size:1.8rem; }
      .flip-stage{ height:calc(100vh - 180px);} /* 给移动端多留一点空间 */
    }
  </style>
</head>
<body>
  <div class="header" id="header">
    <div class="title" id="chapterTitle">鹫巢外传 第二部</div>
    <div class="subtitle" id="chapterSubtitle">中文汉化版 | Cloudinary CDN加速</div>
  </div>

  <!-- 阅读模式工具条 -->
  <div class="viewer-toolbar" id="viewerToolbar">
    <div class="inner">
      <label>
        <i class="fa-solid fa-book-open"></i> 阅读模式
        <select id="viewMode">
          <option value="scroll">竖向滚动（默认）</option>
          <option value="flip1">翻页·单页</option>
          <option value="flip2">翻页·双页</option>
        </select>
      </label>
      <label title="双页模式下，是否把第1页单独作为扉页显示">
        <input type="checkbox" id="firstSingle" checked /> 扉页单独显示
      </label>
      <button id="toggleNav"><i class="fa-solid fa-compass"></i> 章节导航</button>
      <button id="enterFS"><i class="fa-solid fa-up-right-and-down-left-from-center"></i> 全屏</button>
    </div>
  </div>

  <div class="notice">本汉化仅作学习参考交流使用，不可以任何形式进行盈利。</div>

  <!-- 竖向滚动阅读 -->
  <div class="comic-container" id="comic-container">
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>正在加载漫画，请稍候...</p>
      <p><i class="fas fa-cloud"></i> 使用Cloudinary CDN加速中</p>
    </div>
  </div>

  <!-- 翻页阅读（单页/双页共用） -->
  <div class="flip-view" id="flipView">
    <div class="flip-stage" id="flipStage"></div>
    <div class="flip-hotspot left" id="flipPrev" aria-label="上一页"></div>
    <div class="flip-hotspot right" id="flipNext" aria-label="下一页"></div>
  </div>

  <!-- 碎碎念区域 -->
  <div class="talk-section" id="talkSection">
    <div class="talk-content" id="talkContent"></div>
  </div>

  <!-- 制作人员 -->
  <div class="footer" id="footer">
    <div class="footer-title">制作人员</div>
    <div class="staff-grid" id="staffGrid"></div>
  </div>

  <!-- 底部状态条 -->
  <div class="status-bar" id="statusBar">
    <i class="fas fa-spinner fa-spin"></i>
    <span id="statusText">加载进度: <span id="loadedCount">0</span>/<span id="totalCount">0</span></span>
    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
    <span class="completed-message" id="completedMessage" style="display:none;"><i class="fas fa-check-circle"></i> 加载完成!</span>
  </div>

  <!-- 章节导航浮层 -->
  <div class="nav-overlay" id="navOverlay">
    <div class="nav-buttons">
      <div class="nav-btn prev" id="prevBtn"><i class="fas fa-arrow-left"></i>上一章</div>
      <div class="nav-btn center" id="homeBtn"><i class="fas fa-home"></i>目录</div>
      <div class="nav-btn next" id="nextBtn"><i class="fas fa-arrow-right"></i>下一章</div>
    </div>
  </div>

  <div class="end-indicator" id="endIndicator"></div>

  <script>
    // ======================== 配置 ========================
    const chapterConfig = {
      partNumber: 2,
      chapterNumber: 9,
      chapterTitle: "從零重新出發",
      imageUrls: [
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287190/%E5%A4%A9%E4%B8%8B9_1_ira0tu.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287191/%E5%A4%A9%E4%B8%8B9_2_jnuow1.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287190/%E5%A4%A9%E4%B8%8B9_3_z65jqs.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287190/%E5%A4%A9%E4%B8%8B9_4_qgxfvd.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287192/%E5%A4%A9%E4%B8%8B9_5_jkdgyb.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287190/%E5%A4%A9%E4%B8%8B9_6_b1kqki.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287198/%E5%A4%A9%E4%B8%8B9_7_nlbf4l.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287195/%E5%A4%A9%E4%B8%8B9_8_aolh5y.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287198/%E5%A4%A9%E4%B8%8B9_9_dhyyyj.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287199/%E5%A4%A9%E4%B8%8B9_10_wru8j9.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287198/%E5%A4%A9%E4%B8%8B9_11_owvqmg.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287199/%E5%A4%A9%E4%B8%8B9_12_yui9h9.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287199/%E5%A4%A9%E4%B8%8B9_13_wsluj6.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287200/%E5%A4%A9%E4%B8%8B9_14_fhlzsu.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287207/%E5%A4%A9%E4%B8%8B9_15_hbohsb.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287201/%E5%A4%A9%E4%B8%8B9_16_phvlit.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287202/%E5%A4%A9%E4%B8%8B9_17_fz9mii.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287206/%E5%A4%A9%E4%B8%8B9_18_su56n9.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287201/%E5%A4%A9%E4%B8%8B9_19_ml8k58.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287206/%E5%A4%A9%E4%B8%8B9_20_gwmm4l.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287207/%E5%A4%A9%E4%B8%8B9_21_pzakyy.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287207/%E5%A4%A9%E4%B8%8B9_22_xcl0de.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287208/%E5%A4%A9%E4%B8%8B9_23_ppi9oq.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287209/%E5%A4%A9%E4%B8%8B9_24_hov96p.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287212/%E5%A4%A9%E4%B8%8B9_25_h9ii0f.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287219/%E5%A4%A9%E4%B8%8B9_26_az2ck4.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287218/%E5%A4%A9%E4%B8%8B9_27_shyy2k.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287219/%E5%A4%A9%E4%B8%8B9_28_zdj9vq.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287217/%E5%A4%A9%E4%B8%8B9_29_pgqdc7.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287220/%E5%A4%A9%E4%B8%8B9_30_f5cffa.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287225/%E5%A4%A9%E4%B8%8B9_31_izuf1w.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287226/%E5%A4%A9%E4%B8%8B9_32_zp5qzp.png",
        "https://res.cloudinary.com/dbulxrm7b/image/upload/v1760287226/%E5%A4%A9%E4%B8%8B9_33_qntpnp.png"
      ],
      staffMembers: [
        { role: "图源", name: "lilocat" },
        { role: "翻译", name: "青空朝颜" },
        { role: "校对", name: "lilocat" },
        { role: "修图", name: "Deco" },
        { role: "嵌字", name: "Deco" }
      ],
      talkContent: `
        <p>隼竟然一直住在鹫巢家，连个自己的房子都没有？！我的天哪，我之前太低估他对鹫巢大人的依赖程度了，这跟小狗还有什么区别？</p>
        <p>不过话说回来，这一章的其他内容还行，一无所有地在贫民窟里混，面无表情被混混们拖来拖去的鹫巢大人反倒可爱起来了</p>
      `
    };

    // 自动为 Cloudinary URL 添加 f_auto,q_auto 优化（避免在源码里出现 $1/$2 导致替换歧义）
    (function optimizeCloudinaryUrls(){
      chapterConfig.imageUrls = chapterConfig.imageUrls.map(url => {
        if (!url.includes('res.cloudinary.com')) return url;
        if (url.includes('/f_') || url.includes('/q_')) return url;
        return url.replace(/(https:\/\/res\.cloudinary\.com\/[^\/]+\/image\/upload\/)(v\d+\/)/, (m,a,b)=> a + 'f_auto,q_auto/' + b);
      });
    })();

    // 预读尺寸用于识别跨页（宽度约为单页的两倍）
    let imgMeta = [];
    let metaReady = false;
    let medianW = 0;
    function measureAll(){
      return Promise.all(
        chapterConfig.imageUrls.map((url, idx) => new Promise(res => {
          const im = new Image();
          im.onload = function(){ imgMeta[idx] = { w: this.naturalWidth, h: this.naturalHeight }; res(); };
          im.onerror = function(){ imgMeta[idx] = { w: 0, h: 0 }; res(); };
          im.src = url;
        }))
      ).then(()=>{
        const widths = imgMeta.map(m => m?.w || 0).filter(w => w>0).sort((a,b)=>a-b);
        medianW = widths.length ? widths[Math.floor(widths.length/2)] : 0;
        metaReady = true;
      });
    }
    function isDouble(i){
      if (!metaReady) return false;
      const w = imgMeta[i]?.w || 0; if (!w || !medianW) return false;
      return w >= 1.6 * medianW; // 阈值：≥1.6倍视为跨页
    }

    // ======================== 初始化 ========================
    document.addEventListener('DOMContentLoaded', function(){
      const comicContainer = document.getElementById('comic-container');
      const flipView = document.getElementById('flipView');
      const flipStage = document.getElementById('flipStage');
      const flipPrev = document.getElementById('flipPrev');
      const flipNext = document.getElementById('flipNext');

      const statusBar = document.getElementById('statusBar');
      const loadedCount = document.getElementById('loadedCount');
      const totalCount = document.getElementById('totalCount');
      const progressBar = document.getElementById('progressBar');
      const statusText = document.getElementById('statusText');
      const header = document.getElementById('header');
      const viewerToolbar = document.getElementById('viewerToolbar');
      const footer = document.getElementById('footer');
      const navOverlay = document.getElementById('navOverlay');
      const prevBtn = document.getElementById('prevBtn');
      const homeBtn = document.getElementById('homeBtn');
      const nextBtn = document.getElementById('nextBtn');
      const endIndicator = document.getElementById('endIndicator');
      const talkSection = document.getElementById('talkSection');

      const viewModeSel = document.getElementById('viewMode');
      const firstSingleCb = document.getElementById('firstSingle');
      const toggleNavBtn = document.getElementById('toggleNav');
      const enterFSBtn = document.getElementById('enterFS');

      // 章节标题
      document.getElementById('chapterTitle').textContent = `鹫巢外传 第二部 第${chapterConfig.chapterNumber}话`;
      document.getElementById('chapterSubtitle').textContent = `${chapterConfig.chapterTitle} | 中文汉化版`;

      // 制作人员
      const staffGrid = document.getElementById('staffGrid');
      chapterConfig.staffMembers.forEach(m => {
        const item = document.createElement('div');
        item.className = 'staff-item';
        item.innerHTML = `<div class=\"staff-role\">${m.role}</div><div class=\"staff-name\">${m.name}</div>`;
        staffGrid.appendChild(item);
      });

      // 碎碎念
      document.getElementById('talkContent').innerHTML = chapterConfig.talkContent;

      totalCount.textContent = chapterConfig.imageUrls.length;
      comicContainer.innerHTML = '';

      // 竖向滚动：懒加载
      function buildScrollMode(){
        comicContainer.innerHTML = '';
        const frag = document.createDocumentFragment();
        chapterConfig.imageUrls.forEach((url, index) => {
          const imgContainer = document.createElement('div');
          imgContainer.className = 'img-container';

          const img = document.createElement('img');
          img.dataset.src = url;
          img.alt = `第 ${index + 1} 页`;
          img.className = 'comic-image';
          img.loading = 'lazy';

          const loadImage = () => { if (img.dataset.src) { img.src = img.dataset.src; delete img.dataset.src; } };
          const io = new IntersectionObserver((entries)=>{
            entries.forEach(en => { if (en.isIntersecting){ loadImage(); io.unobserve(img); } });
          });
          io.observe(img);

          img.onload = () => {
            img.classList.add('loaded');
            const loaded = parseInt(loadedCount.textContent) + 1; loadedCount.textContent = loaded;
            const progress = Math.floor((loaded / chapterConfig.imageUrls.length) * 100); progressBar.style.width = `${progress}%`;
            if (loaded === chapterConfig.imageUrls.length){
              setTimeout(()=>{
                statusText.innerHTML = `已加载全部 <b>${loaded}</b> 张`;
                document.getElementById('completedMessage').style.display = 'inline-flex';
                document.body.appendChild(endIndicator);
              }, 400);
            }
          };

          img.onerror = () => {
            img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="600" viewBox="0 0 400 600"><rect width="400" height="600" fill="%23f8f9fa"/><text x="200" y="300" font-family="Arial" font-size="20" fill="%236c757d" text-anchor="middle">图片加载失败</text></svg>';
            img.classList.add('loaded');
            const loaded = parseInt(loadedCount.textContent) + 1; loadedCount.textContent = loaded;
            const progress = Math.floor((loaded / chapterConfig.imageUrls.length) * 100); progressBar.style.width = `${progress}%`;
          };

          const pageNum = document.createElement('div');
          pageNum.textContent = `第 ${index + 1} 页`;
          pageNum.style.textAlign = 'center'; pageNum.style.margin = '5px 0 15px'; pageNum.style.color = '#6c757d'; pageNum.style.fontSize = '.9rem';

          imgContainer.appendChild(img);
          imgContainer.appendChild(pageNum);
          frag.appendChild(imgContainer);
        });
        comicContainer.appendChild(frag);
      }

      // 翻页模式（单页/双页）
      let flipIndex = 0; // 对单页：代表第几张；对双页：代表第几个“spread”

      function getSpreads(){
        const urls = chapterConfig.imageUrls;
        const spreads = [];
        const firstSingle = firstSingleCb.checked; // 是否第1页单独展示
        if (!urls.length) return spreads;
        let i = 0;
        if (firstSingle){
          spreads.push([urls[0]]);
          i = 1;
        }
        for (; i < urls.length;){
          if (isDouble(i)) { spreads.push([urls[i]]); i += 1; continue; }
          const a = urls[i];
          const b = urls[i+1];
          if (b && !isDouble(i+1)) { spreads.push([a,b]); i += 2; }
          else { spreads.push([a]); i += 1; }
        }
        return spreads;
      }

      function preload(url){ const img = new Image(); img.src = url; }

      function renderFlip(){
        const mode = viewModeSel.value; // flip1 / flip2
        const single = mode === 'flip1';
        const urls = chapterConfig.imageUrls;
        const spreads = single ? urls.map(u => [u]) : getSpreads();
        const total = spreads.length;
        if (flipIndex >= total) flipIndex = total - 1; if (flipIndex < 0) flipIndex = 0;

        flipStage.innerHTML = '';
        const current = spreads[flipIndex];
        current.forEach(u => {
          const img = document.createElement('img');
          img.src = u; // 直接加载当前页（翻页模式优先当前清晰度）
          img.alt = 'page';
          flipStage.appendChild(img);
        });

        // 预加载相邻
        const next = spreads[flipIndex+1];
        const prev = spreads[flipIndex-1];
        if (next) next.forEach(preload);
        if (prev) prev.forEach(preload);

        // 状态条：第几页/总页
        const curLogical = (function(){
          if (single) return flipIndex + 1;
          let count = 0; for(let i=0;i<flipIndex;i++){ count += spreads[i].length; } count += current.length; return count;
        })();
        const logicalTotal = urls.length;
        statusText.innerHTML = `第 <b>${curLogical}</b>/<b>${logicalTotal}</b> 张`;
        progressBar.style.width = `${Math.round((curLogical / logicalTotal) * 100)}%`;

        // 章后内容：仅在最后一个spread时显示
        if (flipIndex === total - 1){
          talkSection.style.display = 'block';
          footer.style.display = 'block';
        } else {
          talkSection.style.display = 'none';
          footer.style.display = 'none';
        }
      }

      function showFlipUI(show){
        const isScroll = !show;
        document.documentElement.style.scrollBehavior = isScroll ? 'smooth' : 'auto';
        document.body.style.overflowY = isScroll ? 'auto' : 'auto'; // 保持可滚动以便看到章后内容
        flipView.style.display = show ? 'block' : 'none';
        comicContainer.style.display = show ? 'none' : 'block';
      }

      // 顶部/底部在滚动或翻页时临时隐藏
      let hideTimer = null;
      function transientHideBars(){
        header.classList.add('hidden');
        viewerToolbar.classList.add('hidden');
        statusBar.classList.add('hidden');
        clearTimeout(hideTimer);
        hideTimer = setTimeout(()=>{
          header.classList.remove('hidden');
          viewerToolbar.classList.remove('hidden');
          statusBar.classList.remove('hidden');
        }, 1200);
      }

      // 初次构建
      buildScrollMode();

      // 滚动时隐藏/显示头尾（滚动模式下启用）
      let lastScrollTop = 0;
      window.addEventListener('scroll', function(){
        if (viewModeSel.value !== 'scroll') return; // 翻页模式不干预
        const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
        if (currentScroll > lastScrollTop && currentScroll > 50){
          header.classList.add('hidden');
          viewerToolbar.classList.add('hidden');
          statusBar.classList.add('hidden');
        } else {
          header.classList.remove('hidden');
          viewerToolbar.classList.remove('hidden');
          statusBar.classList.remove('hidden');
        }
        lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
      });

      // ========= 章节导航 =========
      toggleNavBtn.addEventListener('click', () => navOverlay.classList.add('active'));
      // 点击浮层非按钮区域关闭
      navOverlay.addEventListener('click', (e)=>{ if (!e.target.closest('.nav-btn')) navOverlay.classList.remove('active'); });
      document.getElementById('homeBtn').addEventListener('click', ()=>{ window.location.href = 'https://deco808.github.io/waxizi/index.html'; });
      document.getElementById('prevBtn').addEventListener('click', ()=>{ window.location.href = `chapter${chapterConfig.partNumber}-${chapterConfig.chapterNumber - 1}.html`; });
      document.getElementById('nextBtn').addEventListener('click', ()=>{ window.location.href = `chapter${chapterConfig.partNumber}-${chapterConfig.chapterNumber + 1}.html`; });

      // ========= 模式切换 =========
      const savedMode = localStorage.getItem('viewMode');
      if (savedMode && ['scroll','flip1','flip2'].includes(savedMode)) viewModeSel.value = savedMode;
      const savedFirstSingle = localStorage.getItem('firstSingle');
      if (savedFirstSingle !== null) firstSingleCb.checked = savedFirstSingle === '1';

      async function applyMode(){
        const mode = viewModeSel.value;
        if (mode === 'scroll'){
          showFlipUI(false);
          talkSection.style.display = 'block';
          footer.style.display = 'block';
          return;
        }
        // flip 模式
        if (!metaReady) await measureAll();
        showFlipUI(true);
        flipIndex = 0;
        renderFlip();
      }

      applyMode();
      viewModeSel.addEventListener('change', ()=>{ localStorage.setItem('viewMode', viewModeSel.value); if (viewModeSel.value==='scroll'){ window.scrollTo({top:0}); } applyMode(); });
      firstSingleCb.addEventListener('change', ()=>{ localStorage.setItem('firstSingle', firstSingleCb.checked ? '1':'0'); if (viewModeSel.value==='flip2'){ flipIndex = 0; renderFlip(); } });

      // ========= 翻页（仅鼠标点击） =========
      function goPrev(){ if (viewModeSel.value==='scroll'){ window.scrollBy({top:-window.innerHeight*0.9, behavior:'smooth'}); return; } flipIndex--; transientHideBars(); renderFlip(); }
      function goNext(){ if (viewModeSel.value==='scroll'){ window.scrollBy({top:window.innerHeight*0.9, behavior:'smooth'}); return; } flipIndex++; transientHideBars(); renderFlip(); }

      flipPrev.addEventListener('click', goPrev);
      flipNext.addEventListener('click', goNext);

      // 全屏
      function enterFullscreen(){ const el = document.documentElement; if (el.requestFullscreen) el.requestFullscreen(); else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen(); }
      enterFSBtn.addEventListener('click', enterFullscreen);

      // 点击页面空白处（非浮层和工具条）时，滚动模式下可打开导航，再次点击关闭
      document.body.addEventListener('click', function(e){
        if (e.target.closest('#viewerToolbar, .nav-btn, #flipView, .header, .footer, .status-bar')) return;
        if (viewModeSel.value === 'scroll') navOverlay.classList.toggle('active');
      });
    });
  </script>
</body>
</html>
